<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - تسجيل الطلاب</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        th.sortable {
            cursor: pointer;
            position: relative;
        }
        th.sortable::after {
            content: ' \2195';
            opacity: 0.4;
            position: absolute;
            right: 0.5rem;
        }
        th.sorted-asc::after {
            content: ' \2191';
            opacity: 1;
        }
        th.sorted-desc::after {
            content: ' \2193';
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-cover bg-center" style="background-image: url('images/background.jpg');">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="relative z-10 w-full max-w-md bg-white/95 shadow-2xl rounded-2xl p-8 space-y-6">
            <div class="text-center">
                <h2 class="text-3xl font-bold text-gray-800">لوحة تحكم المسؤول</h2>
                <p class="text-gray-600 mt-2">يرجى تسجيل الدخول للمتابعة</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-semibold text-gray-700 mb-2">اسم المستخدم</label>
                    <input type="email" id="username" required class="w-full px-4 py-3 text-lg bg-gray-100 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="الايميل">
                </div>
                <div>
                    <label for="password" class="block text-sm font-semibold text-gray-700 mb-2">كلمة المرور</label>
                    <input type="password" id="password" required class="w-full px-4 py-3 text-lg bg-gray-100 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="الباسورد">
                </div>
                <div id="login-error" class="text-red-600 text-sm text-center hidden">اسم المستخدم أو كلمة المرور غير صحيحة.</div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition-transform transform hover:scale-105">
                    تسجيل الدخول
                </button>
            </form>
        </div>
    </div>

    <!-- Dashboard Screen -->
    <div id="dashboard-screen" class="hidden p-4 sm:p-6 lg:p-8">
        <header class="flex flex-wrap justify-between items-center mb-6 pb-4 border-b">
            <h1 class="text-3xl font-bold text-gray-800">بيانات الطلاب المسجلين</h1>
             <div class="flex items-center gap-4 mt-4 sm:mt-0">
                <button id="delete-all-button" class="bg-red-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-300 transition">
                    حذف جميع البيانات
                </button>
                <button id="logout-button" class="bg-gray-700 text-white font-bold py-2 px-5 rounded-lg hover:bg-gray-800 focus:outline-none focus:ring-4 focus:ring-gray-300 transition">
                    تسجيل الخروج
                </button>
            </div>
        </header>

        <div class="bg-white shadow-lg rounded-xl p-6">
            <div class="flex justify-between items-center mb-4">
                 <button id="fetch-data-button" class="bg-indigo-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition">
                    تحديث البيانات
                </button>
                <div id="status-container" class="text-gray-600"></div>
            </div>
           
            <div class="overflow-x-auto">
                <table id="students-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-column="0">وقت التسجيل</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-column="1">الاسم الكامل</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">رقم الموبايل</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الرقم القومي</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-column="4">المؤهل</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider sortable" data-column="5">المجموع</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الشكوي</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">بطاقة الترشيح</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Data will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Image Modal -->
    <div id="image-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-2xl p-4 max-w-3xl max-h-[90vh] relative">
            <button id="modal-close-button" class="absolute -top-3 -right-3 bg-white text-gray-700 rounded-full h-8 w-8 flex items-center justify-center text-xl font-bold hover:bg-red-500 hover:text-white transition">&times;</button>
            <img id="modal-image" src="" alt="بطاقة الترشيح" class="object-contain max-w-full max-h-[85vh]">
        </div>
    </div>


    <script>
        const loginScreen = document.getElementById('login-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const fetchDataButton = document.getElementById('fetch-data-button');
        const deleteAllButton = document.getElementById('delete-all-button');
        const tableBody = document.getElementById('table-body');
        const statusContainer = document.getElementById('status-container');
        const loginError = document.getElementById('login-error');
        
        const imageModal = document.getElementById('image-modal');
        const modalImage = document.getElementById('modal-image');
        const modalCloseButton = document.getElementById('modal-close-button');

        const googleScriptUrl = 'https://script.google.com/macros/s/AKfycbwNJlr05_tvef7czjMuS85U8-RI82uxOYtQYoFNmSMYDnw_sFpjNhhXAU_Dd12HVxjd2w/exec';
        
        let studentData = [];
        let sortColumn = -1;
        let sortDirection = 'asc';

        // --- Session Management ---
        function checkSession() {
            if (localStorage.getItem('isLoggedIn') === 'true') {
                loginScreen.classList.add('hidden');
                dashboardScreen.classList.remove('hidden');
                fetchData();
            } else {
                loginScreen.classList.remove('hidden');
                dashboardScreen.classList.add('hidden');
            }
        }

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (username === 'admin@it.com' && password === '123456789') {
                localStorage.setItem('isLoggedIn', 'true');
                loginError.classList.add('hidden');
                checkSession();
            } else {
                loginError.classList.remove('hidden');
            }
        });

        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('isLoggedIn');
            studentData = [];
            renderTable();
            checkSession();
        });

        // --- Data Fetching and Rendering ---
        async function fetchData() {
            statusContainer.innerHTML = `<div class="flex items-center gap-2"><div class="loader"></div><span>جاري تحميل البيانات...</span></div>`;
            fetchDataButton.disabled = true;
            deleteAllButton.disabled = true;
            try {
                const response = await fetch(googleScriptUrl);
                if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                studentData = await response.json();
                renderTable();
                statusContainer.textContent = `تم التحديث بنجاح. إجمالي السجلات: ${studentData.length}`;
            } catch (error) {
                console.error('Fetch Error:', error);
                statusContainer.textContent = 'فشل في تحميل البيانات. تأكد من إعادة نشر الـ Script.';
            } finally {
                fetchDataButton.disabled = false;
                deleteAllButton.disabled = false;
            }
        }

        function renderTable() {
            tableBody.innerHTML = '';
            if (!Array.isArray(studentData) || studentData.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-10 text-gray-500">لا توجد بيانات لعرضها.</td></tr>`;
                 return;
            }
            
            if (sortColumn !== -1) {
                studentData.sort((a, b) => {
                    const valA = a[sortColumn];
                    const valB = b[sortColumn];
                    if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                    if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            studentData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition';
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${row[0] || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${row[1] || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${row[2] || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${row[3] || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${row[4] || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${row[5] || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${row[6] || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                        <a href="${row[7] || '#'}" class="view-image-link text-indigo-600 hover:text-indigo-900 ${!row[7] ? 'opacity-50 pointer-events-none' : ''}">
                            عرض الصورة
                        </a>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }
        
        document.querySelectorAll('th.sortable').forEach(header => {
            header.addEventListener('click', () => {
                const column = parseInt(header.dataset.column);
                if (sortColumn === column) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortDirection = 'asc';
                }
                document.querySelectorAll('th.sortable').forEach(th => th.classList.remove('sorted-asc', 'sorted-desc'));
                header.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
                renderTable();
            });
        });

        fetchDataButton.addEventListener('click', fetchData);

        // --- Delete All Logic ---
        deleteAllButton.addEventListener('click', () => {
            const confirmation = prompt("هذا الإجراء سيحذف جميع بيانات الطلاب والصور بشكل دائم. للتأكيد، اكتب 'حذف الكل' للمتابعة:");
            if (!confirmation || confirmation.trim().replace(/\s+/g, ' ') !== 'حذف الكل') {
                alert('تم إلغاء عملية الحذف.');
                return;
            }

            const password = prompt('الرجاء إدخال كلمة مرور المسؤول للمتابعة:');
            if (password === 'ch3405') {
                deleteAllData();
            } else if (password) { // Only show error if they entered something
                alert('كلمة المرور غير صحيحة. تم إلغاء العملية.');
            }
        });

        async function deleteAllData() {
            statusContainer.innerHTML = `<div class="flex items-center gap-2 text-red-600"><div class="loader" style="border-top-color: #dc2626;"></div><span>جاري حذف جميع البيانات...</span></div>`;
            deleteAllButton.disabled = true;
            fetchDataButton.disabled = true;

            try {
                const response = await fetch(googleScriptUrl, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'deleteAll' }),
                });
                const result = await response.json();
                if (result.result === 'success') {
                    statusContainer.textContent = 'تم حذف جميع البيانات بنجاح!';
                    studentData = [];
                    renderTable();
                } else {
                    throw new Error(result.error || 'فشل حذف البيانات.');
                }
            } catch (error) {
                console.error('Delete Error:', error);
                statusContainer.textContent = `فشل الحذف: ${error.message}`;
            } finally {
                deleteAllButton.disabled = false;
                fetchDataButton.disabled = false;
            }
        }


        // --- Modal Logic Removed ---
        // Only open the link in a new tab
        tableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('view-image-link')) {
                if (e.target.href && e.target.href !== '#') {
                    window.open(e.target.href, '_blank');
                }
                e.preventDefault();
            }
        });

        document.addEventListener('DOMContentLoaded', checkSession);
    </script>
</body>
</html>

